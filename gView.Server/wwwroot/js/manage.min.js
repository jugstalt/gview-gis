window.gview||(window.gview={});window.gview.manage=function(){let f="/";const e="token-",r="~";let y=function(n){f=n},n=function(n){$.ajax({url:f+n.url,type:n.type||"get",data:n.data||null,success:n.success||function(n){alert(n)},error:n.error||function(n,t,i){$(".loading").removeClass("loading");alert("Error: "+i+"("+t+")")}})},t=function(t,i){let r={};t.find(".form-value").length===0?r._emtpyform=!0:t.find(".form-value").each(function(n,t){r[$(t).attr("name")]=$(t).attr("type")==="checkbox"?$(t).prop("checked"):$(t).val()});i.type="post";i.data=r;let u=i.success;i.success=function(n){t.find(".form-error").remove();n.success?u&&u(n):$("<div>").addClass("form-error").html(n.error).prependTo(t)};n(i)},o=function(n){let u=$("<div>").addClass("gview5-modal-blocker").appendTo($("body")).click(function(){}),t=$("<div>").addClass("modal-dialog").appendTo(u).click(function(n){n.stopPropagation()});n.title&&$("<div>"+n.title+"<\/div>").addClass("modal-title").appendTo(t);let i=$("<div>").addClass("modal-body").appendTo(t),r=$("<div>").addClass("modal-footer").appendTo(t);if($("<button>Close<\/button>").addClass("button-close").appendTo(r).click(function(t){if(t.stopPropagation(),n.onClose)n.onClose(i);$(this).closest(".gview5-modal-blocker").remove()}),n.onOk&&$("<button>OK<\/button>").addClass("button-ok").appendTo(r).click(function(t){t.stopPropagation();let r=n.autoClose===!1?!1:!0;if(n.onOk){let t=n.onOk(i);r=r||t}r===!0&&$(this).closest(".gview5-modal-blocker").remove()}),n.onLoad)n.onLoad(i)},s=function(i,r){let u=i.children(".service[data-service='"+(r.folder?r.folder+"/":"")+r.name+"']");u.length===0&&(u=$("<li><\/li>").attr("data-service",(r.folder?r.folder+"/":"")+r.name).addClass("service").appendTo(i));u.removeClass().addClass("service "+r.status).empty();r.hasErrors&&u.addClass("has-errors");let f=$("<div>").addClass("toolbar").appendTo(u);return $("<div>").addClass("icon clickable log").appendTo(f).click(function(){let t=$(this).closest(".service").attr("data-service"),i=function(r,u){r.empty();let f=$("<ul>").appendTo(r);$.each(u.errors,function(n,t){$("<li>").appendTo(f).html(t.replace(/(?:\r\n|\r|\n)/g,"<br>"))});u.ticks&&$("<button>older...<\/button>").appendTo(r).click(function(){n({url:"/manage/serviceerrorlogs?service="+t+"&last="+u.ticks,success:function(n){i(r,n)}})})};o({title:r.name+" (Error Logs)",onLoad:function(r){r.addClass("error-logs");n({url:"/manage/serviceerrorlogs?service="+t,success:function(n){i(r,n)}})}})}),$("<div>").addClass("icon clickable security"+(r.hasSecurity===!0?"1":"0")).appendTo(f).click(function(){let i=$(this).closest(".service").attr("data-service"),u=function(n,t,i){$("<td>✖<\/td>").addClass("remove").appendTo(n).click(function(){$(this).closest("tr").remove()});$("<td>").addClass("username").attr("data-username",i.username).html(i.username).appendTo(n);let r=!1;$.each(t,function(t,u){$cell=$("<td>").addClass("rule").appendTo(n);let f=$.inArray(u.toLowerCase(),i.servicetypes)>=0,e=$("<input type='checkbox' name='"+i.username+"~"+u+"' />").addClass("form-value").prop("checked",f).appendTo($cell);u.indexOf("_")===0&&(u==="_all"?(r=f,e.click(function(){let n=$(this).prop("checked");$(this).closest("tr").find("input.interpreter").css("display",n===!0?"none":"")})):e.addClass("interpreter").css("display",r===!0?"none":""))})},f=function(n,t){n.empty();let f=$("<table>").appendTo(n),i=$("<tr>").appendTo(f),e=$("<th>").appendTo(i);$("<th>").html("User").appendTo(i);$.each(t.allTypes,function(n,t){let r=v(t);r.indexOf("_")===0&&(r="#"+r.substr(1).toUpperCase());$("<th>").addClass("rule").html(r).appendTo(i)});$.each(t.accessRules,function(n,r){i=$("<tr>").appendTo(f);u(i,t.allTypes,r)});i=$("<tr>").appendTo(f);$("<td>").appendTo(i);e=$("<td>").appendTo(i);let r=$("<select>").appendTo(e);$("<option value=''><\/options>").appendTo(r);$("<option value='"+t.anonymousUsername+"'>"+t.anonymousUsername+"<\/option>").appendTo(r);$.each(t.allUsers,function(n,t){$("<option value='"+t+"'>").html(t).appendTo(r)});r.click(function(){if(val=$(this).val(),val&&$(this).closest("table").find(".username[data-username='"+val+"']").length===0){i=$("<tr>").insertBefore($(this).closest("tr"));let n=[];$.each(t.allTypes,function(t,i){(i.indexOf("_")!==0||i==="_all")&&n.push(i.toLowerCase())});u(i,t.allTypes,{username:val,servicetypes:n})}$(this).val("")})};o({title:r.name+" (Security)",onLoad:function(t){t.addClass("service-security");n({url:"/manage/servicesecurity?service="+i,success:function(n){f(t,n)}})},onOk:function(n){t(n,{url:"/manage/servicesecurity?service="+i,success:function(n){console.log(n);s($(".gview-manage-body").find(".services"),n.service)}})}})}),$("<div>").addClass("icon clickable start "+(r.status==="running"?"gray":"")).appendTo(f).click(function(){h(this,$(this).closest(".service"),"running")}),$("<div>").addClass("icon clickable stop "+(r.status==="stopped"?"gray":"")).appendTo(f).click(function(){h(this,$(this).closest(".service"),"stopped")}),$("<div>").addClass("icon clickable settings").appendTo(f).click(function(){let f=$(this).closest(".service").attr("data-service"),i=[],u=null,t=null;o({title:r.name+" (Metadata)",autoClose:!1,onLoad:function(r){r.addClass("service-security");n({url:"/manage/servicemetadata?service="+f,success:function(n){i=n;let f=$("<select>").css({width:"100%",height:25}).appendTo(r);for(let n in n)$("<option>").attr("value",n).text(n).appendTo(f);let e=$("<div>").css({width:"100%",height:"calc(100% - 30px)"}).appendTo(r);u=monaco.editor.create(e.get(0),{language:"yaml",automaticLayout:!0,contextmenu:!1,theme:"vs-dark"});f.change(function(){t&&(i[t]=u.getValue());t=$(this).val();u.setValue(i[t])});f.trigger("change")}})},onOk:function(){return u&&t&&(i[t]=u.getValue()),n({url:"/manage/servicemetadata",type:"post",data:{service:f,metadata:i},success:function(n){n.success?$(".gview5-modal-blocker").remove():alert(n.error)}}),!1}})}),$("<div>").addClass("icon clickable refresh").appendTo(f).click(function(){h(this,$(this).closest(".service"),"refresh")}),$("<h4>"+r.name+"<\/h4>").appendTo(u),r.runningSince&&$("<div>Running since: "+r.runningSince+"<\/div>").appendTo(u),u},c=function(t){let i=$(".services").empty();n({url:"/manage/services?folder="+t,success:function(n){$.each(n.services,function(n,t){s(i,t)})}})},p=function(){let i=$(".gview-manage-body").empty().addClass("loading");n({url:"/manage/folders",success:function(u){i.removeClass("loading");let s=$("<div>").addClass("container").css("max-height","unset").appendTo(i),f=$("<ul>").addClass("folders").appendTo(s);$("<li>").addClass("folder selected").html("(root)").attr("data-folder","").appendTo(f);$.each(u.folders,function(i,u){if(u){let i=$("<li>").addClass("folder").html(u.name).attr("data-folder",u.name).appendTo(f),s=$("<div>").addClass("toolbar").appendTo(i);$("<div>").addClass("icon clickable security"+(u.hasSecurity===!0?"1":"0")).appendTo(s).click(function(i){i.stopPropagation();let f=function(n,t,i){let u=i.username.indexOf(e)===0?i.username.split(r)[0]:i.username;$("<td>✖<\/td>").addClass("remove").appendTo(n).click(function(){$(this).closest("tr").remove()});$("<td>").addClass("username").attr("data-username",u).html(u).appendTo(n);let f=!1;$.each(t,function(t,r){$cell=$("<td>").addClass("rule").appendTo(n);let u=$.inArray(r.toLowerCase(),i.servicetypes)>=0,e=$("<input type='checkbox' name='"+i.username+"~"+r+"' />").addClass("form-value").prop("checked",u).appendTo($cell);r.indexOf("_")===0&&(r==="_all"?(f=u,e.click(function(){let n=$(this).prop("checked");$(this).closest("tr").find("input.interpreter").css("display",n===!0?"none":"")})):e.addClass("interpreter").css("display",f===!0?"none":""))})},s=function(n,t,i){n.empty();let s=$("<table>").appendTo(n),u=$("<tr>").appendTo(s),h=$("<th>").appendTo(u);$("<th>").html("User").appendTo(u);$.each(t.allTypes,function(n,t){let i=v(t);i.indexOf("_")===0&&(i="#"+i.substr(1).toUpperCase());$("<th>").addClass("rule").html(i).appendTo(u)});$.each(t.accessRules,function(n,i){u=$("<tr>").appendTo(s);f(u,t.allTypes,i)});u=$("<tr>").appendTo(s);$("<td>").appendTo(u);h=$("<td>").appendTo(u);let o=$("<select>").appendTo(h);if($("<option value=''><\/options>").appendTo(o),$("<option value='"+t.anonymousUsername+"'>"+t.anonymousUsername+"<\/option>").appendTo(o),$.each(t.allUsers,function(n,t){let i=t.indexOf(e)===0?t.split(r)[0]:t;$("<option value='"+i+"'>").html(i).appendTo(o)}),o.click(function(){if(val=$(this).val(),val&&$(this).closest("table").find(".username[data-username='"+val+"']").length===0){u=$("<tr>").insertBefore($(this).closest("tr"));let n=[];$.each(t.allTypes,function(t,i){(i.indexOf("_")!==0||i==="_all")&&n.push(i.toLowerCase())});f(u,t.allTypes,{username:val,servicetypes:n})}$(this).val("")}),i){let r=$("<div>").addClass("section").appendTo(n);$("<h4>Folder Settings<\/h4>").appendTo(r);let i=$("<div>").addClass("form-input").appendTo(r);$("<div>").addClass("label").text("Online Resource (override)").appendTo(i);$("<br>").appendTo(i);$("<input name='advancedsettings_onlineresource'>").addClass("form-value").val(t.onlineResource).appendTo(i);i=$("<div>").addClass("form-input").appendTo(r);$("<div>").addClass("label").text("Output Url (override)").appendTo(i);$("<br>").appendTo(i);$("<input name='advancedsettings_outputurl'>").addClass("form-value").val(t.outputUrl).appendTo(i)}};o({title:u.name+" (Security)",onLoad:function(t){t.addClass("service-security");n({url:"/manage/foldersecurity?folder="+u.name,success:function(n){s(t,n,!0)}})},onOk:function(n){t(n,{url:"/manage/foldersecurity?folder="+u.name,success:function(n){if(n&&n.success&&n.folder){let t=$(".folders .folder[data-folder='"+n.folder.name+"']"),i="security"+(n.folder.hasSecurity===!0?"1":"0");t.find(".icon.clickable.security1").length>0?t.find(".icon.clickable.security1").removeClass("security1").addClass(i):t.find(".icon.clickable.security0").length>0&&t.find(".icon.clickable.security0").removeClass("security0").addClass(i)}}})}})})}});f.children(".folder").click(function(){$(this).parent().children(".folder").removeClass("selected");c($(this).addClass("selected").attr("data-folder"))});let h=$("<ul>").addClass("services").appendTo(s);c("")}})},h=function(t,i,r){$(t).addClass("loading");n({url:"/manage/setservicestatus?service="+i.attr("data-service")+"&status="+r,type:"post",success:function(n){$(t).removeClass("loading");s(i.closest(".services"),n.service)}})},u=function(n,t,i,r,u,f){let e=$("<div>").addClass("form-input").appendTo(n);$("<div>").addClass("label").html(r||t).appendTo(e);$("<br/>").appendTo(e);let o=$("<input name='"+t+"' type='"+(i||"text")+"' autocomplete='off' />").addClass("form-value").appendTo(e);u===!0&&o.attr("readonly","readonly");f&&o.val(f)},w=function(n,t,i){$("<input type='hidden' name='"+t+"' />").val(i).addClass("form-value").appendTo(n)},l=function(n){let f=$(".user-properties").empty(),r=$("<div>").addClass("form").appendTo(f);n===""?(u(r,"NewUsername","text","New client"),u(r,"NewPassword","password","New secret"),$("<button>Create<\/button>").appendTo(r).click(function(){t(r,{url:"/manage/tokenusercreate",success:function(){i()}})})):(w(r,"Username",n),u(r,"NewPassword","password","New secret"),$("<button>Change<\/button>").appendTo(r).click(function(){t(r,{url:"/manage/tokenuserchangepassword",success:function(){i()}})}),$("<button>Delete<\/button>").css("background","red").appendTo(r).click(function(){confirm("Are you sure? Delete Client?")&&t(r,{url:"/manage/tokenuserdelete",success:function(){i()}})}))},a=function(n){let e=$(".urltoken-properties").empty(),f=$("<div>").addClass("form").appendTo(e);n===""?(u(f,"NewTokenName","text","New Token Name"),$("<button>Create<\/button>").appendTo(f).click(function(){t(f,{url:"/manage/urltokencreate",success:function(){i()}})})):(u(f,"UrlToken","text","Token",!0,n),$("<button>Recycle<\/button>").appendTo(f).click(function(){confirm("Are you sure? Recycle Token?")&&t(f,{url:"/manage/urltokenrecycle",success:function(){i(".urltoken."+n.split(r)[0])}})}),$("<button>Delete<\/button>").css("background","red").appendTo(f).click(function(){confirm("Are you sure? Delete Token?")&&t(f,{url:"/manage/urltokendelete",success:function(){i()}})}))},i=function(t){let i=$(".gview-manage-body").empty().addClass("loading");n({url:"/manage/tokenusers",success:function(n){let o=$("<div>").addClass("container").appendTo(i),s=f+"/geoservices/tokens/generatetoken";$("<div>").addClass("info").html("Clients can login to get access to GeoServices services. A client can login (programatically) here <a href='"+s+"' target='_blank'>"+s+"<\/a> with clientId and secret to receive an access token.").appendTo(o);let h=$("<ul>").addClass("users").appendTo(o);$("<li>New Client...<\/li>").addClass("user new selected").appendTo(h).click(function(){$(this).parent().children(".user").removeClass("selected");$(this).addClass("selected");l("")});$.each(n.users,function(n,t){t.indexOf(e)!==0&&$("<li>").addClass("user").attr("data-user",t).html(t).appendTo(h).click(function(){$(this).parent().children(".user").removeClass("selected");$(this).addClass("selected");l($(this).attr("data-user"))})});$("<div>").addClass("user-properties").appendTo(o);let u=$("<div>").addClass("container").appendTo(i);$("<div>").addClass("info").html("Url Tokens are experimental! This functionality may no longer be offered in the future!").appendTo(u);$("<div>").addClass("info").html("Url Tokens are static tokens and must be send in every url request to a secured GeoServices service: "+f+"/geoservices(token-xxx~...)/rest/services/... There is no clientId necessary. Anyone who owns the token can use the corresponding service.").appendTo(u);let c=$("<ul>").addClass("urltokens").appendTo(u);$("<li>New (Url) Token<\/li>").addClass("urltoken new").appendTo(c).click(function(){$(this).parent().children(".urltoken").removeClass("selected");$(this).addClass("selected");a("")});$.each(n.users,function(n,t){t.indexOf(e)===0&&$("<li>").addClass("urltoken "+t.split(r)[0]).attr("data-user",t).html(t.split(r)[0]).appendTo(c).click(function(){$(this).parent().children(".user").removeClass("selected");$(this).addClass("selected");a($(this).attr("data-user"))})});$("<div>").addClass("urltoken-properties").appendTo(u);console.log("triggerCLick",t);i.find(t||".user.new").trigger("click")}})},v=function(n){if(n)switch(n.toLowerCase()){case"map":return"Export Map";case"query":return"Query";case"edit":return"Features";case"publish":return"Publish Serivices"}return n};return{pageServices:p,pageSecurity:i,setRootUrl:y}}();